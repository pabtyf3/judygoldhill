<?php

/**
 * @author pabtyf
 * @copyright 2012
 */

class exhibition{
    
    var $id="";
    var $title="";
    var $location="";
    var $shortdesc="";
    var $startdate="";
    var $enddate="";
    var $page="";
    var $offset="";
    var $per_page="6";
    //var $enddate="";
    var $content="";
    var $filter="";
    var $archive="";
    //var $image="";
    
    
    function __construct($id="",$page="",$filter=""){
        $this->page = $page;
        $this->filter = $filter;
        if($id!=""){
            
            $this->id=$id;
            $this->populate();
        }
    }
    
    function populate(){
        $sql ="SELECT * FROM `exhibition` WHERE `id`='".$this->id."'";
        $res = mysql_query($sql);
        if(mysql_num_rows($res)<1){
            
        }else{
            $row = mysql_fetch_assoc($res);
            foreach($row as $k=>$v){
                $this->$k=$v;
            }
        }
    }
    

    
    
    function form($action="add"){
        $tiny = new tinymce("content,shortdesc","adv_simp");
        $ret = $tiny->script;
        $ret.='<script type="text/javascript">
        $(function(){
        
        $(".datePick").datepicker({"dateFormat":"dd-mm-yy", changeMonth: true,
     changeYear: true,
       });
     ';
    
    if($action=="edit"){
     $ret.="$('#newim').hide();
        $('#imch').click(function(){
           $('#newim').toggle(); 
            
        });
     ";   
    }
    
    $ret.='   
    
    });
    </script>
    ';
    
    
        
        
        $ret.="<form action = '/jg-admin/actions/formProcess.php' enctype='multipart/form-data' method='post'><fieldset>";
        $ret.="<input type='hidden' name='class' value='exhibition' />";
        $ret.="<input type='hidden' name='id' value='".$this->id."'/>";
        $ret.="<input type='hidden' name='action' value='".$action."' />";
        $ret.="<input type='hidden' name='ret' value='/jg-admin/admin.php?class=exhibition' />";
        $ret.="<table>";
            $ret.="<tr><td>Title: </td><td><input type='text' class='the300' name='title' value='".$this->title."' /></td></tr>";
            $ret.="<tr><td>Location: </td><td><input type='text' class='the300' name='location' id='location' value='".$this->location."' /></td></tr>";
           $ret.="<tr><td>Start Date: </td><td><input type='text' name='startdate' id='startdate' class='datePick' value='".flipdate($this->startdate)."' /></td></tr>";
            $ret.="<tr><td>End Date: </td><td><input type='text' name='enddate' id='enddate' class='datePick' value='".flipdate($this->enddate)."' /></td></tr>";
           
             $ret.="<tr><td style='vertical-align:top;'>Short Description: </td><td><textarea name='shortdesc' id='shortdesc' rows='6' cols='40' width='500px'><div>".$this->shortdesc."</div></textarea></td></tr>";
            
            $ret.="<tr><td style='vertical-align:top;'>Details: </td><td><textarea name='content' id='content' rows='20' cols='40' width='500px'><div>".$this->content."</div></textarea></td></tr>";
        
            
             $ret.="<tr><td colspan='2'><input type='submit' name='sC' value='Save' /></td></tr>";
        $ret.="</table></fieldset></form>";
        return($ret);
    }
    
    
    function processForm(){
        if($_POST['action']=="add"){
            //$alias = new projectalias();
            //$alias->makeAlias($_POST['name']);
            $sql = "INSERT INTO `exhibition` SET 
            `title`='". mysql_real_escape_string(stripslashes(htmlentities($_POST['title'], ENT_QUOTES,'UTF-8',false)))."',
            `location`='". mysql_real_escape_string(stripslashes(htmlentities($_POST['location'], ENT_QUOTES,'UTF-8',false)))."',
            `shortdesc`='". mysql_real_escape_string(stripslashes(str_replace(array("<div>","</div>"),"",$_POST['shortdesc'])))."',
            `startdate`='".flipdate($_POST['startdate'])."',
        `enddate`='".flipdate($_POST['enddate'])."',
            `content` = '".mysql_real_escape_string(stripslashes(str_replace(array("<div>","</div>"),"",$_POST['content'])))."'
            ";
            mysql_query($sql);
            //$id = mysql_insert_id();
           // echo $sql;
           // exit();
            
            //$im = new image();
            //$im->newsupload("/_temp","news",$id);
            
        }else{
           
           
              $sql = "UPDATE `exhibition` 
              SET `title`='". mysql_real_escape_string(stripslashes(htmlentities($_POST['title'], ENT_QUOTES,'UTF-8',false)))."',
            `location`='". mysql_real_escape_string(stripslashes(htmlentities($_POST['location'], ENT_QUOTES,'UTF-8',false)))."',
            `shortdesc`='". mysql_real_escape_string(stripslashes(str_replace(array("<div>","</div>"),"",$_POST['shortdesc'])))."',
            `startdate`='".flipdate($_POST['startdate'])."',
        `enddate`='".flipdate($_POST['enddate'])."',
            `content` = '".mysql_real_escape_string(stripslashes(str_replace(array("<div>","</div>"),"",$_POST['content'])))."'";
          
            
            $sql.="
            WHERE `id`='".$this->id."' LIMIT 1";
                       
            mysql_query($sql);
            //if(isset($_POST['imch'])&&$_POST['imch']==1){
             // $im = new image();
            //$im->newsupload("/_temp","news",$this->id);  
           // }
            
        }
        
       
       //     return(mysql_insert_id());
        //}
        
    }
    
    
    function updateImage($file,$id){
        $sql = "UPDATE `news` SET `image`='".$file."' WHERE `id`='".$id."' LIMIT 1";
        mysql_query($sql);        
    }
    
    
    

    
    
            function admin(){
        $sql = "SELECT * FROM `exhibition` ORDER BY `startdate` DESC";
        $res = mysql_query($sql);
        $ret="<a href='/jg-admin/actions/add.php?class=exhibition' class='falsebutton'><img src='/css/icons/add.png' alt='Add an Exhibition' />Add Exhibition</a>";
        $ret.="<table style='width:750px;'>
            <tr><th>Exhibition Title</th><th>Location</th><th>Actions</th></tr>";
            $x=0;  
        while($row = mysql_fetch_assoc($res)){
            $c = $x%2==0?" class='odd'":"";
            $tNews = new exhibition($row['id']);
            $ptitle = $tNews->title;
                
            
            $ret.="<tr".$c."><td style='text-align:center;'>".$ptitle."</td><td>".$tNews->location."</td><td style='text-align:center;'>";
      $ret.=" <a href='/jg-admin/actions/edit.php?class=exhibition&id=".$tNews->id."'><img src='/css/icons/pencil.png' alt='Edit Exhibition' /></a>";
      $ret.=" | <a href='/jg-admin/actions/switcher.php?class=exhibition&id=".$tNews->id."' title='";
      $ret.=$tNews->archive==1?"Un-archive this Exhibition":"Archive this Exhibition";
      $ret.="'><img src='/css/icons/";
      $ret.=$tNews->archive==1?"un":"";
      $ret.="archive.png' /></a>";
        
                $pm = new pmeta();
        if($pm->hasPmeta("exhibition",$tNews->id)){
            $ret.=" | <a href='/jg-admin/actions/edit.php?class=pmeta&type=exhibition&typeid=".$tNews->id."'><img src='/css/icons/edittag.png' alt='Edit Metadata' /></a>";
            
        }else{
            $ret.=" | <a href='/jg-admin/actions/add.php?class=pmeta&type=exhibition&typeid=".$tNews->id."'><img src='/css/icons/addtag.png' alt='Add Metadata' /></a>";
            
        }
        
       $ret.=" | <a href='/jg-admin/actions/delete.php?class=exhibition&id=".$tNews->id."' title='Delete this Exhibition'><img src='/css/icons/bin_closed.png' /></a>";
                    
                $ret.="</td></tr>";
            
            
            $x++;
        }
        $ret.="</table>";
        
        return($ret);
    }
    
    
    
    
    function to_content(){
        if($this->id==""){
            $ret = $this->get_news_list();
        }else{
            $ret = $this->get_article();
        }
        return($ret);
        
    }
    
    function get_news_list(){
        
        if($this->page!=""){
            $offset = $this->page*$this->per_page; 
        }else{
            $offset=0;
        }
        $limit = " LIMIT ".$offset.",".$this->per_page;
        
        if($this->filter!=""){
            if($this->filter=="archive"){
                $filt = " WHERE `archive`='1' ";
            }
            if(is_numeric($this->filter)){
                $filt = " WHERE YEAR(startdate) = '".$this->filter."' AND `archive`='0'";
            }
        }else{
            $filt=" WHERE `archive`='0'";
        }
        
        
        $sql = "SELECT * FROM `exhibition`".$filt." ORDER BY `startdate` DESC";
        $sql.=$limit;
        //echo $sql;
        $res = mysql_query($sql);
        if(mysql_num_rows($res)<1){
            
        }else{
            
            while($row = mysql_fetch_assoc($res)){
                $tcont = new exhibition($row['id']);
                $im = $tcont->strip_first_image();
                $nali = new alias();
$alias = $nali->makeAlias_nocheck($tcont->title);
       $ret.='        <!-- exhibition item-->
<div id="exhibition_item">
<span class="demiItalic">'.$tcont->title.'</span><br />
<span class="demi">'.$tcont->location.'</span><br /><br />

<span class="grey">'.$tcont->reader_date_from_to().'</span><br /><br />

'.$tcont->shortdesc.'<br /><br />

<a href="/exhibitions/'.$tcont->id.'/'.$alias.'/">Read More...</a><br />

'.$tcont->strip_first_image().'

<div class="newsdivider"></div>

<!-- end exhibition item-->
</div>';
            }
           
           
        }
        
     $pag = new paging($this->page,$this->per_page,"exhibition",$filt." ORDER BY `startdate` DESC","/exhibitions/");
           $ret.=$pag->output;
        //var_dump($pag);
       return($ret); 
        
    }
    
    function strip_first_image(){
        
        preg_match_all('/<img ([^>]*)>/', $this->content, $result, PREG_PATTERN_ORDER);
$result = $result[0];
        //var_dump($result);
        if(count($result)>0){
            //return()
            //$im = str_replace(array(""),array(""),"");
                       $string = $result[0];
             $width = "";
 $height = "";
if (preg_match('/width="([0-9]*)"/', $string, $regs)) {
	$width = $regs[1];
} 
 if (preg_match('/height="([0-9]*)"/', $string, $regs)) {
	$height = $regs[1];
}

if($width > $height){
    $patterns = array();
  $patterns[0] = '/height="([0-9]*)"/';
            $patterns[1] = '/width="([0-9]*)"/';
            $replacements = array();
            $replacements[1] ='width="215"';
            $replacements[0] ='';
            ksort($patterns);
            ksort($replacements);
            return("<br />".preg_replace($patterns, $replacements, $string));
}else{
     $patterns = array();
  $patterns[0] = '/height="([0-9]*)"/';
            $patterns[1] = '/width="([0-9]*)"/';
            $replacements = array();
            $replacements[0] ='height="135"';
            $replacements[1] ='';
            ksort($patterns);
            ksort($replacements);
            return("<br />".preg_replace($patterns, $replacements, $string)); 
}
            
            
            
            /*
            
            $patterns[0] = '/height="([0-9]*)"/';
            $patterns[1] = '/width="([0-9]*)"/';
            $replacements[1] ='width="215"';
            $replacements[0] ='height="135"';
            return("<br />".preg_replace($patterns, $replacements, $result[0]));
            */
            
            
        }else{
            return("");
        }
    }
    
    
    function get_article(){
        $ret='<div id="article">
<span class="demiItalic">'.$this->title.'</span><br />
<span class="demi">'.$this->location.'</span><br /><br />
<span class="grey">'.$this->reader_date_from_to().'</span><br /><br />
<p class="article_text">
'.str_replace("<img","<img class='newsImage'",$this->content).'
</p>';
$share = new shares();
$ret.=$share->output['0'];
$ret.=$share->output['1'];
$ret.'
<!-- end news article-->
</div>';
return($ret);
    }
    
    function reader_date($date=""){
        if($date!=""){
            return(date("j F Y",strtotime($date)));
        }
        
    }
 
 
    function for_leftnav(){
        $ret='<div id="leftnavarea2">';
        $sql = "SELECT DISTINCT YEAR(startdate) as `year` FROM `exhibition` ORDER BY `startdate` DESC";
        $res = mysql_query($sql);
        if(mysql_num_rows($res)>0){
            $ret.="Filter by date<br />";
             $dateLess2 = date("Y")-2;
            while($row = mysql_fetch_assoc($res)){
                if($row['year']>$dateLess2){
                    $ret.="<a href='/exhibitions/year/".$row['year']."/'>".$row['year']."</a><br />";
                }
            }
        }
        
        $sql2 = "SELECT `id` FROM `exhibition` WHERE `archive`='1'";
        $res2 = mysql_query($sql2);
        if(mysql_num_rows($res2)<1){
            
        }else{
            $ret.='<a href="/exhibitions/archive/">Archive</a>';
        }
        $ret.='


<!-- end left nav 2-->
</div>';
return($ret);
    }
 
 
 function switcher($field="archive"){
    if($this->archive==1){
        $narchive = 0;
    }else{
        $narchive=1;
    }
    $sql = "UPDATE `exhibition` SET `archive`='".$narchive."' WHERE `id`='".$this->id."' LIMIT 1";
    mysql_query($sql);
    
 }
 
     
    function reader_date_from_to(){
        $s = strtotime($this->startdate);
        $e = strtotime($this->enddate);
        $sy = date("Y",$s);
        $ey = date("Y",$e);
        $sm = date("F",$s);
        $em = date("F",$e);
        $sd = date("j",$s);
        $ed = date("j",$e);
        
        if($em!=$sm){
            if($ey==$sy){
                $rDate = $sd." ".$sm." - ".$ed." ".$em." ".$sy;
            }else{
                $rDate = $sd." ".$sm." ".$sy." - ".$ed." ".$em." ".$ey;
            }
            
            
        }else{
            
            if($ey==$sy){
                $rDate = $sd."-".$ed." ".$sm." ".$sy;
            }else{
                 $rDate = $sd." ".$sm." ".$sy." - ".$ed." ".$em." ".$ey;
            }
            
        }
        
        
        return($rDate);
        
    }
         function delete(){
            if($this->id!=""){
                $sql = "DELETE FROM `exhibition` WHERE `id`='".$this->id."'";
                mysql_query($sql);
            }
        }
    
}

?>