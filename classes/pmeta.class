<?php

/**
 * @author phpdes
 * @copyright 2013
 */



    class pmeta{
        
        var $id="";
        var $type="";
        var $metatitle="";
        var $metadesc="";
        var $metakey="";
        var $typeid="";
        
        function __construct($typeid="",$type=""){
            if($type!=""&&$typeid!=""){
            $this->type=$type;
            $this->typeid=$typeid;
            $this->populate();
            }else{
               // $this->defaults();
            }
        }
        
        function defaults(){
            /*$nDefaults = new metadefaults();
            $this->metatitle=$nDefaults->metatitle;
            $this->metadesc=$nDefaults->metadesc;
            $this->metakey=$nDefaults->metakey;*/
            $sql = "SELECT * FROM `".$this->type."` WHERE `id`='".$this->typeid."'";
            $res = mysql_query($sql);
            if(mysql_num_rows($res)<1){
                
            }else{
            $row = mysql_fetch_assoc($res);
            $this->metatitle=$this->type=="project"?"Judy Goldhill - ".$row['name']:"Judy Goldhill - ".$row['title'];
            $this->metadesc=strip_tags($row['shortdesc']);
            $this->metakey=strip_tags($row['shortdesc']);
            }
        }
        
        function populate(){
            $sql = "SELECT * FROM `pmeta` WHERE `type`='".$this->type."' AND `typeid`='".$this->typeid."'";
           // echo $sql;
            $res = mysql_query($sql);
            if(mysql_num_rows($res)<1){
                $this->defaults();
            }else{
                $row = mysql_fetch_assoc($res);
                foreach($row as $k=>$v){
                    $this->$k=$v;
                }
                $this->metatitle="Judy Goldhill - ".str_replace("Judy Goldhill - ","",$this->metatitle);
            }
        }
        
        
        function form($action="add"){
                    $tiny = new tinymce("metadesc,metakey","mega_simple");
        $ret = $tiny->script;
        $ret.="<style type='text/css'>.mceToolbar, .mceStatusbar  {
            display:none;
            }</style>";
                    $ret.="<form action = '/jg-admin/actions/formProcess.php' enctype='multipart/form-data' method='post'><fieldset>";
        $ret.="<input type='hidden' name='class' value='pmeta' />";
        $ret.="<input type='hidden' name='id' value='".$this->id."'/>";
        $ret.="<input type='hidden' name='action' value='".$action."' />";
        $ret.="<input type='hidden' name='ret' value='/jg-admin/admin.php?class=".$_GET['type']."' />";
        $ret.="<input type='hidden' name='typeid' value='".$_GET['typeid']."' />";
        $ret.="<input type='hidden' name='type' value='".$_GET['type']."' />";
        $ret.="<table>";
            $ret.="<tr><td>Meta Title: </td><td><input type='text' name='metatitle' style='width:300px;' id='metatitle' value='".$this->metatitle."' /></td></tr>";
            $ret.="<tr><td>Meta Description: </td><td><textarea name='metadesc' id='metadesc' rows='5' cols=''>".$this->metadesc."</textarea></td></tr>";
            $ret.="<tr><td>Meta Keywords: </td><td><textarea name='metakey' id='metakey' rows='5' cols=''>".$this->metakey."</textarea></td></tr>";
        $ret.="<tr><td colspan='2'><input type='submit' name='sC' value='Save' /></td></tr>";
        $ret.="</table></fieldset></form>";
        return($ret);
        }
        
        function processForm(){
            if($_POST['action']=="add"){
                $sql = "INSERT INTO `pmeta` SET `metatitle`='".mysql_real_escape_string(htmlentities(stripslashes($_POST['metatitle']),ENT_QUOTES,"UTF-8",false))."',
                `metadesc` = '".mysql_real_escape_string(stripslashes($_POST['metadesc']))."',
                `metakey` = '".mysql_real_escape_string(stripslashes($_POST['metakey']))."',
                `type`='".$_POST['type']."',
                `typeid`='".$_POST['typeid']."'";
                mysql_query($sql);
            }else{
                $sql = "UPDATE `pmeta` SET `metatitle`='".mysql_real_escape_string(htmlentities(stripslashes($_POST['metatitle']),ENT_QUOTES,"UTF-8",false))."',
                `metadesc` = '".mysql_real_escape_string(stripslashes($_POST['metadesc']))."',
                `metakey` = '".mysql_real_escape_string(stripslashes($_POST['metakey']))."',
                `type`='".$_POST['type']."',
                `typeid`='".$_POST['typeid']."' WHERE `id`='".$_POST['id']."' LIMIT 1";
                mysql_query($sql);
                
            }
        }
        
        
        
       function hasPmeta($type,$typeid){
         $sql = "SELECT * FROM `pmeta` WHERE `type`='".$type."' AND `typeid`='".$typeid."'";
            $res = mysql_query($sql);
            if(mysql_num_rows($res)<1){
                return(false);
            }else{
                return(true);
            }
       } 
        
           function meta(){
        //$this->checkmeta();
        $ret = "<title>".$this->metatitle."</title>";
        $ret.='<meta name="description" content="'.$this->metadesc.'" />
<meta name="keywords" content="'.$this->metakey.'" />';
return($ret);
    } 
    }

?>