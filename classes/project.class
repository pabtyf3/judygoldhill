<?php

/**
 * @author dotnet works
 * @copyright 2013
 */


 class project{



var $id='';
var $name='';
var $description='';
var $category='';
var $archived='';
var $order='';
var $metatitle='';
var $metadesc='';
var $metakey='';
var $active='';

var $thumbnail="";

function __construct($id=""){

if($id!=""){
        $this->id = $id;
        $this->populate();
        }
        }

function populate(){
        $sql = "SELECT * FROM `project` WHERE `id`='".$this->id."' LIMIT 1";
        $res = mysql_query($sql);
        if(mysql_num_rows($res) <1){
            
            }else{
                $row = mysql_fetch_assoc($res);
                foreach($row as $k=>$v){
                    $this->$k=$v;
                    }
                  $this->thumbnail= $this->my_thumbnail(); 
                }
        }

    
       function form($action="add"){
        $tiny = new tinymce("description,shortdesc,related","adv_simp");
        $ret = $tiny->script;
        //$retpage = $this->action=="add"?"/jg-admin.php?"
        
        $ret.="<form action = '/jg-admin/actions/formProcess.php' enctype='multipart/form-data' method='post'><fieldset>";
        $ret.="<input type='hidden' name='class' value='project' />";
        $ret.="<input type='hidden' name='id' value='".$this->id."'/>";
        $ret.="<input type='hidden' name='action' value='".$action."' />";
        $ret.="<input type='hidden' name='ret' value='/jg-admin/admin.php?class=project' />";
        $ret.="<table>";
            $ret.="<tr><td>Title: </td><td><input type='text' class='the300' name='name' value='".$this->name."' /></td></tr>";
            $tCat = new projectcategories();
            $ret.="<tr><td>Category: </td><td>".$tCat->dropdown($this->category)."</td></tr>";
            
       $ret.="<tr><td style='vertical-align:top;'>Short Description: </td><td><textarea name='shortdesc' id='shortdesc' rows='6' cols='40' width='500px'>".$this->shortdesc."</textarea></td></tr>";
       $ret.="<tr><td style='vertical-align:top;'>Details: </td><td><textarea name='description' id='description' rows='20' cols='40' width='500px'>".$this->description."</textarea></td></tr>";
       $ret.="<tr><td style='vertical-align:top;'>Related: </td><td><textarea name='related' id='related' rows='6' rows='40' width='500px'>".$this->related."</textarea></td></tr> "; 
            
             $ret.="<tr><td colspan='2'><input type='submit' name='sC' value='Save' /></td></tr>";
        $ret.="</table></fieldset></form>";
        return($ret);
    } 
    

     function processForm(){
        if($_POST['action']=="add"){
            //$alias = new projectalias();
            //$alias->makeAlias($_POST['name']);
            $sql = "INSERT INTO `project` SET 
            `name`='". mysql_real_escape_string(stripslashes(htmlentities($_POST['name'], ENT_QUOTES,'UTF-8',false)))."',
            
            `shortdesc`='". mysql_real_escape_string(stripslashes($_POST['shortdesc']))."',
          `category`='".$_POST['category']."',
            `description` = '".mysql_real_escape_string(stripslashes($_POST['description']))."',
            `related` = '".mysql_real_escape_string(stripslashes($_POST['related']))."'
            ";
            mysql_query($sql);
            //$id = mysql_insert_id();
           // echo $sql;
           // exit();
            
            //$im = new image();
            //$im->newsupload("/_temp","news",$id);
            
        }else{
           
           
              $sql = "UPDATE `project` 
              SET `name`='". mysql_real_escape_string(stripslashes(htmlentities($_POST['name'], ENT_QUOTES,'UTF-8',false)))."',
           
              `shortdesc`='". mysql_real_escape_string(stripslashes($_POST['shortdesc']))."',
          `category`='".$_POST['category']."',
            `description` = '".mysql_real_escape_string(stripslashes($_POST['description']))."',
            `related` = '".mysql_real_escape_string(stripslashes($_POST['related']))."'";
          
            
            $sql.="
            WHERE `id`='".$this->id."' LIMIT 1";
                       
            mysql_query($sql);
            //if(isset($_POST['imch'])&&$_POST['imch']==1){
             // $im = new image();
            //$im->newsupload("/_temp","news",$this->id);  
           // }
            
        }
        
       
       //     return(mysql_insert_id());
        //}
        
    }
    
    
        
            function admin(){
                $filter = isset($_GET['filter'])&&$_GET['filter']!=""?" WHERE `category`='".$_GET['filter']."'":""; 
        
        $sql = "SELECT * FROM `project`".$filter." ORDER BY `id` DESC";
        $res = mysql_query($sql);
        $ret="<a href='/jg-admin/actions/add.php?class=project' class='falsebutton'><img src='/css/icons/add.png' alt='Add a new Work item' />Add Work</a>";
        $ret.="<table style='width:750px;'>
        <tr><td></td><td></td><td>Filter : ";
        
        $pcat = new projectcategories();
       $ret.= $pcat->dropdown($_GET['filter'],"filter","all");
        $ret.="<script type='text/javascript'>
                $(function(){
                    $('#filter').change(function(){
                        if($(this).val()=='none'){
                            window.location = '/jg-admin/admin.php?class=project';
                            }else{
                               window.location = '/jg-admin/admin.php?class=project&filter='+$(this).val();   
                                }
                    });
                    
                });
        </script>";
        
        $ret.="</td></tr>
            <tr><th>Work Name</th><th>Category</th><th>Actions</th></tr>";
            $x=0;  
        while($row = mysql_fetch_assoc($res)){
            $c = $x%2==0?" class='odd'":"";
            $tNews = new project($row['id']);
            $ptitle = $tNews->name;
                
            
            $ret.="<tr".$c."><td style='text-align:center;'>".$ptitle."</td><td style='text-align:center;'>";
            $pcat2 = new projectcategories($tNews->category);
            $ret.=$pcat2->category;
            $ret.="</td><td style='text-align:center;'>";
      $ret.=" <a href='/jg-admin/actions/edit.php?class=project&id=".$tNews->id."'><img src='/css/icons/pencil.png' alt='Edit Work' /></a>";
      $ret.=" | <a href='/jg-admin/actions/switcher.php?class=project&id=".$tNews->id."' title='";
      $ret.=$tNews->active==0?"Disabled (Click to show on front end)":"Active (Click to hide on front end)";
      $ret.="'><img src='/css/icons/";
      $ret.=$tNews->active==0?"in":"";
      $ret.="active.png' /></a>";
        
        if($tNews->category=="8"){
            $ret.=" | <a href='/jg-admin/admin.php?class=projectvideo&project_id=".$tNews->id."'><img src='/css/icons/vimeo.png' alt='Add Vimeo Video' /></a>";
        }else{
            $ret.=" | <a href='/jg-admin/admin.php?class=projectimage&project_id=".$tNews->id."'><img src='/css/icons/images.png' alt='Add Images' /></a>";
             
        }
        
        $pm = new pmeta();
        if($pm->hasPmeta("project",$tNews->id)){
            $ret.=" | <a href='/jg-admin/actions/edit.php?class=pmeta&type=project&typeid=".$tNews->id."'><img src='/css/icons/edittag.png' alt='Edit Metadata' /></a>";
            
        }else{
            $ret.=" | <a href='/jg-admin/actions/add.php?class=pmeta&type=project&typeid=".$tNews->id."'><img src='/css/icons/addtag.png' alt='Add Metadata' /></a>";
            
        }
        
        
       $ret.=" | <a href='/jg-admin/actions/delete.php?class=project&id=".$tNews->id."' title='Delete this Work'><img src='/css/icons/bin_closed.png' /></a>";
                    
                $ret.="</td></tr>";
            
            
            $x++;
        }
        $ret.="</table>";
        
        return($ret);
    }




 function switcher($field="active"){
    if($this->$field==1){
        $narchive = 0;
    }else{
        $narchive=1;
    }
    $sql = "UPDATE `project` SET `".$field."`='".$narchive."' WHERE `id`='".$this->id."' LIMIT 1";
    mysql_query($sql);
    
 }
 

    
    function my_thumbnail(){
        if($this->category==8){
            $pi = new projectvideo();
            $myThumb=$pi->getMyThumb($this->id);
        }else{
        $pi = new projectimage();
        $myThumb = $pi->getMyThumb($this->id);
        }
        return($myThumb);
    }
    
    

    function work_page(){
        $filter=$_GET['filter'];
        if($filter!=""){
            $pc = new projectcategories();
            $filter_id = " AND `category`='".$pc->get_by_name($filter)."' ";
        }else{
            $filter_id="";
            
        }
        $sql = "SELECT * FROM `project` WHERE `active` ='1' ".$filter_id." ORDER BY `order` ASC";
        $res = mysql_query($sql);
        while($row = mysql_fetch_assoc($res)){
            //echo $row['id'];
            $tProj = new project($row['id']);
              $cat = new projectcategories($tProj->category);
            $alias = new alias();
            $ali = $alias->makeAlias_nocheck($tProj->name);
            
          $ret.='<div class="workIndexImages"><a  class="imgLnk" id="img'.$tProj->id.'" href="/work/'.$cat->category.'/'.$tProj->id.'/'.$ali.'/"><img src="'.$tProj->thumbnail.'" ';
          $ret.=$tProj->category==8?" height='136px'":"";
          $ret.=' alt="'.$tProj->name.'"/></a></div>';  
        }
        $ret.='<script type="text/javascript">
$(window).load(function() {
	$(".workIndexImages").each(function(i) {
    $(this).delay(400*i).fadeIn(2000);
  });
});
</script>';
       return($ret); 
        
    }
    
    
    function forLeftnav(){
            $filter=$_GET['filter'];
        if($filter!=""){
            $pc = new projectcategories();
            $filter_id = $pc->get_by_name($filter);
        }else{
            $filter_id="";
            
        }
        
        $pc = new projectcategories();
        $ret= $pc->for_leftnav($filter_id);
        $ret.=$this->projects_for_nav();
        return($ret);
        
        
    }
    
    function projects_for_nav(){
                $filter=$_GET['filter'];
        if($filter!=""){
            $pc = new projectcategories();
            $filter_id = " AND `category`='".$pc->get_by_name($filter)."' ";
        }else{
            $filter_id="";
            
        }
        $sql = "SELECT * FROM `project` WHERE `active` ='1' ".$filter_id." ORDER BY `order` ASC";
        $res = mysql_query($sql);
        $ret='<div id="leftnavarea3">
<span class="italic">
<ul class="leftnavlist3">
';

        
        
        while($row = mysql_fetch_assoc($res)){
            $cat = new projectcategories($row['category']);
            $alias = new alias();
            $ali = $alias->makeAlias_nocheck($row['name']);
            $ret.="<li><a class='proj_title' rel='".$row['id']."'  id='proj".$row['id']."' href='/work/".$cat->category."/".$row['id']."/".$ali."/'>".$row['name']."</a></li>";
            }
            
            
            $ret.='

</ul>
</span>
<script type="text/javascript">
$(function(){
   $(".proj_title").hover(function(){
        var rel = $(this).attr("rel");
        $("#img"+rel).fadeTo("fast",0.5);
        $(this).css("color","#da291c");
   },function(){
     var rel = $(this).attr("rel");
        $("#img"+rel).fadeTo("fast",1);
        $(this).css("color","#666666");
   }) 
   
   $(".imgLnk").hover(function(){
        var relB = $(this).attr("id").split("img");
        var rel = relB[1];
        $("#proj"+rel).css("color","#da291c");
        $(this).fadeTo("fast",0.5);
   },function(){
        var relB = $(this).attr("id").split("img");
        var rel = relB[1];
        $("#proj"+rel).css("color","#666666");
        $(this).fadeTo("fast",1);
   })
   
   
});
</script>
</div>';
return($ret);
    }
    
    
        function work_as_thumbs(){
  
                  $cat = new projectcategories($this>category);
            $alias = new alias();
            $ali = $alias->makeAlias_nocheck($this->name);
  
  
        if($this->category==8){
                        $pim = new projectvideo();
            $images = $pim->getByProject($this->id);        
            foreach($images as $k=>$v){
                $i=$k+1;
            //echo $row['id'];
            //$tProj = new project($row['id']);
          $ret.='<div class="workIndexImages"><a class="imgLnk" id="img'.$this->id.'" href="/work/'.$cat->category.'/'.$this->id.'/'.$ali.'/slideshow/'.$i.'/"><img src="'.$v['thumbnail'].'" ';
          $ret.=" height='136px'";
          $ret.=' alt="'.$v['title'].'"/></a></div>';  
        }
        }else{
            $pim = new projectimage();
            $images = $pim->getByProject($this->id);        
            foreach($images as $k=>$v){
                 $i=$k+1;
            //echo $row['id'];
            //$tProj = new project($row['id']);
          $ret.='<div class="workIndexImages"><a class="imgLnk" id="img'.$this->id.'" href="/work/'.$cat->category.'/'.$this->id.'/'.$ali.'/slideshow/'.$i.'/"><img src="/images/projects/thumbs/'.$v['file'].'" ';
         // $ret.=$tProj->category==5?" height='136px'":"";
          $ret.=' alt="'.$v['title'].'"/></a></div>';  
        }
        }
  
  
       // $sql = "SELECT * FROM `project` WHERE `active` ='1' ".$filter_id." ORDER BY `order` ASC";
        //$res = mysql_query($sql);

        $ret.='<script type="text/javascript">
$(window).load(function() {
	$(".workIndexImages").each(function(i) {
    $(this).delay(400*i).fadeIn(2000);
  });
});
</script>';
       return($ret); 
        
    }
    
    function work_info(){
      
                $ret='<div id="article">
'.$this->description.'
</div>';

return($ret);
    }
    
    
    function single_project_leftnav(){
                       $cat = new projectcategories($this>category);
            $alias = new alias();
            $ali = $alias->makeAlias_nocheck($this->name);
            $view = isset($_GET['view'])&&$_GET['view']!=""?$_GET['view']:"";
  
        
        $ret = '<div id="leftnavarea2">

<div id="project_desc_summary"><span class="demiItalic">'.$this->name.'</span><br />';

if($view!="info"&&$view!="slideshow"){
$ret.=' '.$this->shortdesc.'</div><br />';
}else{
    if($view=="slideshow"){
    $ret.="<em id='activeCaption'></em></div><br/>";
    }else{
        $ret.="<br /></div><br/>";
    }
    
}
if($view!="info"&&$view!="slideshow"){
$ret.='<a href="/work/'.$cat->category.'/'.$this->id.'/'.$ali.'/info/">Read More...</a><br />';
}else{
    if($view!="info"){
   $ret.='<a href="/work/'.$cat->category.'/'.$this->id.'/'.$ali.'/info/">Project info</a><br />';
   }else{
     $ret.='Project info<br />';
   }
   $ret.='<a href="/work/'.$cat->category.'/'.$this->id.'/'.$ali.'/">Thumbnails</a><br />';
   
    
}
$shares = new shares();
$ret.=$shares->output[0];
$ret.=$shares->output[1];
$ret.='

<!-- end left nav 2-->
</div>

<div class="navdivider"></div>

<!-- left nav 3 - related -->
<div id="leftnavareaRelated">

<div class="leftnavlist1">

';
if($this->related!=""){
  $ret.='<span class="active">Related<span><br />'.$this->related;  
}

$ret.='
</div>

</div>';
return($ret);
    }
    
    
    
    function as_slides(){
        $ret='<link href="/css/newSlides.css" rel="stylesheet" type="text/css" />';
                  $ret.='<div id="slides">
<ul id="slides_container" style="width: 100%;">';
$captions = "<div id='captions'>";
$nyros = "";

        if($this->category==8){
                        $pim = new projectvideo();
            $images = $pim->getByProject($this->id);        
            foreach($images as $k=>$v){
            //echo $row['id'];
            $i=$k+1;
            $vid = new projectvideo($v['id']);
            //$tProj = new project($row['id']);
          $ret.='<li class="swrap" id="swrap'.$i.'"><span id="slide'.$i.'">'.$vid->embed_code.'</span></li>'; 
           $captions.="<span id='caption".$i."'>".$v['title']."</span>"; 
           
        }
        }else{
            $pim = new projectimage();
            $images = $pim->getByProject($this->id);        
            foreach($images as $k=>$v){
                $i = $k+1;
            //echo $row['id'];
            //$tProj = new project($row['id']);
          $ret.='<li class="swrap" id="swrap'.$i.'"><img class="rSlide" src="/images/projects/'.$v['file'].'" ';
         // $ret.=$tProj->category==5?" height='136px'":"";
            $ret.="style='max-width:100%; max-height:100%; '";
          $ret.=' alt="'.$v['title'].'" id="slide'.$i.'"/></li>'; 
          $captions.="<span id='caption".$i."'>".nl2br($v['title'])."</span>"; 
          $nyros.='<a href="/images/projects/'.$v['file'].'" id="nM'.$i.'" class="nyroModal" rel="gal" style="position:absolute; z-index:1;"><img src="/images/btn_fullscreen.gif" width="16" height="13" alt="full screen"/></a>
';
        }
        }
        
        $captions.="</div>";
  //$startslide = isset($_GET['slide'])&&is_numeric($_GET['slide'])?$_GET['slide']:1;      
        $ret.='
</ul>

<div id="slide_control">
    <div id="buttons"><span class="prev"></span>
        <span class="current"></span>
    <span class="next"></span></div>
<div id="fullscreen">
'.$nyros.'
</div>
</div>	

</div>';
$ret.=$captions;
 $ret.= '
 <script type="text/javascript" src="/js/nyroModal-1/js/jquery.nyroModal-1.6.2.min.js"></script>
    <script src="/js/newSlideshow.js" type="text/javascript"></script>
<script src="/js/touchwipe.1.1.1.js" type="text/javascript"></script>
       <script type="text/javascript">
     $(function(){
        auto="";
       initSlides(';
       $ret.=isset($_GET['slide'])&&$_GET['slide']!=""?$_GET['slide']:"1";
       $ret.=');
        //alert("TESTING");
     })
     
   
    </script> 

';

return($ret);
    }
    
      function delete(){
            if($this->id!=""){
                $sql = "DELETE FROM `project` WHERE `id`='".$this->id."'";
                mysql_query($sql);
            }
        }
    
    

}
?>